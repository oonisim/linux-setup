# This needs to be templated and moved to site.nginx
server {
    listen {{ WEB_PORT }}      default_server;
    listen [::]:{{ WEB_PORT }} default_server;
    #server_name     localhost;

    return          301 https://$http_host$request_uri;
}

server {
    listen {{ WEB_PORT_SECURE }} ssl default_server so_keepalive=2m:2m:5;
	listen [::]:{{ WEB_PORT_SECURE }} ssl default_server so_keepalive=2m:2m:5;
    #listen 443 ssl so_keepalive=2m:2m:5;
    server_name                 localhost;

    ssl_certificate             {{ nginx_conf_dir }}/ssl/ssl.crt;
    ssl_certificate_key         {{ nginx_conf_dir }}/ssl/ssl.key;
    ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers                 EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
    ssl_prefer_server_ciphers   on;

    gzip            on;
    gzip_proxied    any;
    gzip_types      text/plain text/xml text/css application/x-javascript application/javascript;
    gzip_vary       on;

    location / {
        add_header  X-UI-Version    "2.0";
        root        /opt/compass/app/web/assets/;
        index       index.html index.htm;
    }

    location ~ ^/(api/|mdm/|v2/|login$|logout$) {
        proxy_pass          http://{{ UD_HOST }}:{{ UD_PORT }};
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header    Host            $http_host;

        proxy_connect_timeout   300;
        proxy_send_timeout      300;
        proxy_read_timeout      3600;
        send_timeout            300;
    }

    location ~ ^/subscribe {
        proxy_pass          http://{{ UD_HOST }}:{{ UD_PORT }};
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header    Host            $http_host;

        proxy_connect_timeout   300;
        proxy_send_timeout      300;
        proxy_read_timeout      3600;
        send_timeout            300;

        # nginx docs: http://nginx.org/en/docs/http/websocket.html
        proxy_http_version  1.1;
        proxy_set_header    Upgrade         $http_upgrade;
        proxy_set_header    Connection      "upgrade";
    }
}
